<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kotlin Platformer (TeaVM)</title>
    <style>
      html, body { margin: 0; padding: 0; height: 100%; background: #151a22; }
      #canvas { width: 100%; height: 100%; display: block; }
      .touch-controls {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 38vh;
        pointer-events: none;
        display: none;
      }
      .touch-controls .pad,
      .touch-controls .actions {
        position: absolute;
        bottom: 4vw;
        pointer-events: auto;
      }
      .touch-controls .pad { left: 4vw; width: 40vw; height: 30vw; max-width: 260px; max-height: 200px; }
      .touch-controls .actions { right: 4vw; width: 30vw; height: 30vw; max-width: 200px; max-height: 200px; }
      .touch-btn {
        position: absolute;
        width: 40%;
        height: 40%;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        font: 600 14px/1.1 system-ui, -apple-system, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        touch-action: none;
      }
      .touch-btn:active,
      .touch-btn.active { background: rgba(120, 200, 255, 0.25); border-color: rgba(120, 200, 255, 0.6); }
      .btn-up { left: 30%; top: 0; }
      .btn-down { left: 30%; bottom: 0; }
      .btn-left { left: 0; top: 30%; }
      .btn-right { right: 0; top: 30%; }
      .btn-fire { right: 0; bottom: 0; width: 70%; height: 70%; border-radius: 50%; font-size: 16px; }
      @media (pointer: coarse), (hover: none) {
        .touch-controls { display: block; }
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <div class="touch-controls" id="touch-controls" aria-hidden="true">
      <div class="pad">
        <div class="touch-btn btn-up" data-key="ArrowUp">Up</div>
        <div class="touch-btn btn-down" data-key="ArrowDown">Down</div>
        <div class="touch-btn btn-left" data-key="ArrowLeft">Left</div>
        <div class="touch-btn btn-right" data-key="ArrowRight">Right</div>
      </div>
      <div class="actions">
        <div class="touch-btn btn-fire" data-key="Space">Fire</div>
      </div>
    </div>
    <script src="scripts/gdx.wasm.js"></script>
    <script src="scripts/howler.js"></script>
    <script src="app.js"></script>
    <script>
      const keyMap = {
        ArrowUp: { key: "ArrowUp", code: "ArrowUp", keyCode: 38 },
        ArrowDown: { key: "ArrowDown", code: "ArrowDown", keyCode: 40 },
        ArrowLeft: { key: "ArrowLeft", code: "ArrowLeft", keyCode: 37 },
        ArrowRight: { key: "ArrowRight", code: "ArrowRight", keyCode: 39 },
        Space: { key: " ", code: "Space", keyCode: 32 }
      };

      function dispatchKey(type, keyName) {
        const info = keyMap[keyName] || { key: keyName, code: keyName, keyCode: 0 };
        const event = new KeyboardEvent(type, {
          key: info.key,
          code: info.code,
          keyCode: info.keyCode,
          which: info.keyCode,
          bubbles: true
        });
        window.dispatchEvent(event);
        document.dispatchEvent(event);
      }

      function bindTouchControls() {
        const buttons = document.querySelectorAll(".touch-btn[data-key]");
        buttons.forEach(btn => {
          const keyName = btn.getAttribute("data-key");
          const onDown = (e) => {
            e.preventDefault();
            btn.classList.add("active");
            dispatchKey("keydown", keyName);
          };
          const onUp = (e) => {
            e.preventDefault();
            btn.classList.remove("active");
            dispatchKey("keyup", keyName);
          };
          btn.addEventListener("pointerdown", onDown);
          btn.addEventListener("pointerup", onUp);
          btn.addEventListener("pointercancel", onUp);
          btn.addEventListener("pointerleave", onUp);
        });
      }

      window.addEventListener("load", () => {
        bindTouchControls();
        if (typeof main === "function") {
          main();
        } else {
          console.error("TeaVM main() not found.");
        }
      });
    </script>
  </body>
</html>
